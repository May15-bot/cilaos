<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RUN ‚Üí Cilaos ‚Äì OSRM</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root {
      --couleur-fond: #FFFDF6;
      --couleur-surface: #FAF6E9;
      --couleur-accent: #A0C878;
      --couleur-texte: #384924;
      --couleur-blanc: #FFFFFF;
    }
    html, body { height: 100%; margin: 0; background: var(--couleur-fond); color: var(--couleur-texte); }
    #map { height: 100%; width: 100%; }
    .marker-label { background: var(--couleur-blanc); color: var(--couleur-texte); padding: 4px 8px; border-radius: 6px; font-size: 12px; border: 1px solid rgba(0,0,0,0.1); }
    .toast {
      position: absolute; top: 12px; left: 12px; z-index: 9999;
      background: #ffffff; border: 1px solid rgba(0,0,0,.1); border-radius: 8px;
      padding: 8px 12px; font-family: system-ui, sans-serif; font-size: 13px;
      box-shadow: 0 4px 14px rgba(0,0,0,.08);
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="toast" class="toast" style="display:none"></div>
<script>
(function() {
  const RUN = { lat: -20.8900, lon: 55.5164 };
  const CILAOS = { lat: -21.1364, lon: 55.4719 };
  const CITIES = [
    { name: 'Saint-Denis',  lat: -20.8789, lon: 55.4481 },
    { name: 'Saint-Paul',   lat: -21.0096, lon: 55.2692 },
    { name: 'Saint-Pierre', lat: -21.3393, lon: 55.4781 },
    { name: 'Le Tampon',    lat: -21.2833, lon: 55.5170 },
    { name: 'Cilaos',       lat: -21.1364, lon: 55.4719 }
  ];

  function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.display = 'block';
  }

  // 1) Initialiser la carte avec un centre et un zoom par d√©faut
  const map = L.map('map');
  map.setView([RUN.lat, RUN.lon], 10); // Important: permet d'afficher la tuile m√™me si le fetch √©choue

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '\u00a9 OpenStreetMap \u00a9 CARTO',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  // Marqueurs (affich√©s quoi qu'il arrive)
  L.marker([RUN.lat, RUN.lon], { icon: L.divIcon({ className: 'marker-label', html: 'üõ´ RUN' }) }).addTo(map);
  L.marker([CILAOS.lat, CILAOS.lon], { icon: L.divIcon({ className: 'marker-label', html: 'üèîÔ∏è Cilaos' }) }).addTo(map);
  CITIES.forEach(c => {
    L.marker([c.lat, c.lon], { icon: L.divIcon({ className: 'marker-label', html: 'üìç ' + c.name }) }).addTo(map);
  });

  // 2) Waypoints OSRM (lon, lat)
  const WAYPOINTS = [
    [55.5164, -20.8900], // RUN
    [55.3550, -20.9660], // La Possession
    [55.2850, -21.0150], // Saint-Paul
    [55.2800, -21.1500], // Saint-Leu
    [55.3300, -21.2550], // √âtang-Sal√©
    [55.4050, -21.2850], // Saint-Louis (d√©but RN5)
    [55.4719, -21.1364]  // Cilaos
  ];

  function osrmUrl(waypoints) {
    const coords = waypoints.map(([lng, lat]) => `${lng},${lat}`).join(';');
    return `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson&steps=false&annotations=false`;
  }

  async function drawOsrmRoute() {
    try {
      const url = osrmUrl(WAYPOINTS);
      console.log('OSRM URL:', url);
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error(`OSRM renvoie ${res.status}`);
      const data = await res.json();
      console.log('OSRM data:', data);
      if (!data.routes || !data.routes[0]) throw new Error('Pas de route trouv√©e');

      const geometry = data.routes[0].geometry; // GeoJSON LineString (lng,lat)
      const routeLayer = L.geoJSON(
        { type: 'Feature', geometry },
        { style: { color: '#D21F3C', weight: 5 } }
      ).addTo(map);

      map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
    } catch (err) {
      console.error(err);
      showToast("Impossible de r√©cup√©rer l'itin√©raire OSRM. V√©rifie la console (F12) : " + err.message);
      // Option de repli: relier simplement RUN √† CILAOS en ligne bris√©e
      const fallback = L.polyline([[RUN.lat, RUN.lon], [CILAOS.lat, CILAOS.lon]], { color: '#D21F3C', dashArray: '6 8' }).addTo(map);
      map.fitBounds(fallback.getBounds(), { padding: [20, 20] });
    }
  }

  drawOsrmRoute();
})();  
</script>
</body>
</html>
