<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Cilaos - Trajet interactif</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Space Grotesk', sans-serif;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* Styles pour les marqueurs personnalis√©s */
        .custom-marker {
            background: white;
            border: 2px solid #A0C878;
            border-radius: 50%;
            width: 35px !important;
            height: 35px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #384924;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .custom-marker.airport {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
            width: 100px !important;
            height: 35px !important;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .custom-marker.destination {
            background: #A0C878;
            color: white;
            border-color: #A0C878;
            width: 80px !important;
            height: 35px !important;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .poi-marker {
            background: #FF5722;
            color: white;
            border: 3px solid white;
            width: 32px !important;
            height: 32px !important;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000 !important;
            animation: fadeInPoi 0.5s ease;
        }
        
        .poi-marker.office {
            background: #D21F3C;
            width: 45px !important;
            height: 45px !important;
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeInPoi {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 3px 10px rgba(210, 31, 60, 0.3);
            }
            50% {
                box-shadow: 0 3px 20px rgba(210, 31, 60, 0.6);
                transform: scale(1.1);
            }
            100% {
                box-shadow: 0 3px 10px rgba(210, 31, 60, 0.3);
            }
        }
        
        /* Info box */
        .info-box {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            font-family: 'Space Grotesk', sans-serif;
            transition: all 0.3s;
        }
        
        .info-box h4 {
            color: #A0C878;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-text {
            font-size: 13px;
            color: #384924;
            line-height: 1.4;
            max-width: 300px;
        }
        
        /* L√©gende des POI */
        .poi-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            max-width: 250px;
        }
        
        .poi-legend.visible {
            display: block;
            animation: slideInRight 0.5s ease;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .poi-legend h5 {
            color: #A0C878;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .poi-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .poi-number {
            width: 24px;
            height: 24px;
            background: #FF5722;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-box">
        <h4 id="info-title">üó∫Ô∏è Trajet vers Cilaos</h4>
        <div class="info-text" id="info-text">
            37 kilom√®tres de route spectaculaire √† travers les paysages de La R√©union
        </div>
    </div>
    
    <div class="poi-legend" id="poiLegend">
        <h5>Points d'int√©r√™t</h5>
        <div class="poi-item">
            <div class="poi-number">1</div>
            <span>Piton des Neiges</span>
        </div>
        <div class="poi-item">
            <div class="poi-number">2</div>
            <span>Roche Merveilleuse</span>
        </div>
        <div class="poi-item">
            <div class="poi-number">3</div>
            <span>Col du Ta√Øbit</span>
        </div>
        <div class="poi-item">
            <div class="poi-number">4</div>
            <span>Cascade Bras Rouge</span>
        </div>
        <div class="poi-item">
            <div class="poi-number">5</div>
            <span>Thermes de Cilaos</span>
        </div>
    </div>

    <script>
        // Coordonn√©es principales
        const AIRPORT = { lat: -20.8900, lon: 55.5164, name: "‚úàÔ∏è A√©roport" };
        const PORT = { lat: -20.9396, lon: 55.2906, name: "‚öì Le Port" };
        const ST_LEU = { lat: -21.1708, lon: 55.2885, name: "üèñÔ∏è Saint-Leu" };
        const ST_LOUIS = { lat: -21.2808, lon: 55.4119, name: "üåâ Saint-Louis" };
        const CILAOS = { lat: -21.1364, lon: 55.4719, name: "üèîÔ∏è Cilaos" };
        const OFFICE = { lat: -21.1364, lon: 55.4719, name: "üìç Office Tourisme" };
        
        // Points d'int√©r√™t √† Cilaos (pour l'√©tape 3 zoom Saint-Louis)
        const POI_CILAOS = [
            { lat: -21.1150, lon: 55.4550, name: '1', label: 'Piton des Neiges (3070m)' },
            { lat: -21.1280, lon: 55.4630, name: '2', label: 'Roche Merveilleuse' },
            { lat: -21.1100, lon: 55.4850, name: '3', label: 'Col du Ta√Øbit' },
            { lat: -21.1420, lon: 55.4680, name: '4', label: 'Cascade Bras Rouge' },
            { lat: -21.1350, lon: 55.4700, name: '5', label: 'Thermes de Cilaos' }
        ];
        
        // Waypoints d√©taill√©s pour OSRM (trajet exact)
        const WAYPOINTS = [
            [55.5164, -20.8900], // A√©roport Roland Garros
            [55.4481, -20.8789], // Saint-Denis
            [55.3550, -20.9660], // La Possession
            [55.2906, -20.9396], // Le Port
            [55.2692, -21.0096], // Saint-Paul
            [55.2885, -21.1708], // Saint-Leu
            [55.3300, -21.2550], // √âtang-Sal√©
            [55.4119, -21.2808], // Saint-Louis
            [55.4250, -21.2600], // Entr√©e RN5
            [55.4400, -21.2300], // Premiers virages
            [55.4550, -21.2000], // Mont√©e vers Cilaos
            [55.4650, -21.1700], // Route des 400 virages
            [55.4719, -21.1364]  // Cilaos centre
        ];
        
        // Initialiser la carte
        const map = L.map('map', {
            center: [-21.0300, 55.3800],
            zoom: 10,
            zoomControl: true,
            scrollWheelZoom: false,
            doubleClickZoom: false
        });
        
        // Tuiles de carte
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap ¬© CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Variables globales
        let routeComplete = null;
        let segments = [];
        let currentSegment = 0;
        let poiMarkers = [];
        let poiVisible = false;
        let cityMarkers = [];
        
        // Cr√©er les marqueurs des villes principales
        function createCityMarkers() {
            // A√©roport
            cityMarkers.airport = L.marker([AIRPORT.lat, AIRPORT.lon], {
                icon: L.divIcon({
                    className: 'custom-marker airport',
                    html: AIRPORT.name,
                    iconSize: [100, 35]
                })
            }).addTo(map);
            
            // Le Port
            cityMarkers.port = L.marker([PORT.lat, PORT.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: PORT.name,
                    iconSize: [70, 35]
                })
            }).addTo(map);
            
            // Saint-Leu
            cityMarkers.stleu = L.marker([ST_LEU.lat, ST_LEU.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: ST_LEU.name,
                    iconSize: [80, 35]
                })
            }).addTo(map);
            
            // Saint-Louis
            cityMarkers.stlouis = L.marker([ST_LOUIS.lat, ST_LOUIS.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: ST_LOUIS.name,
                    iconSize: [90, 35]
                })
            }).addTo(map);
            
            // Cilaos
            cityMarkers.cilaos = L.marker([CILAOS.lat, CILAOS.lon], {
                icon: L.divIcon({
                    className: 'custom-marker destination',
                    html: CILAOS.name,
                    iconSize: [80, 35]
                })
            }).addTo(map);
        }
        
        // Cr√©er les marqueurs POI (cach√©s initialement)
        function createPOIMarkers() {
            POI_CILAOS.forEach((poi, index) => {
                const marker = L.marker([poi.lat, poi.lon], {
                    icon: L.divIcon({
                        className: 'custom-marker poi-marker',
                        html: poi.name,
                        iconSize: [32, 32]
                    })
                });
                
                marker.bindTooltip(poi.label, { 
                    permanent: false, 
                    direction: 'top',
                    offset: [0, -16]
                });
                
                poiMarkers.push(marker);
            });
            
            // Marqueur Office de Tourisme
            const officeMarker = L.marker([OFFICE.lat, OFFICE.lon], {
                icon: L.divIcon({
                    className: 'custom-marker poi-marker office',
                    html: 'üìç',
                    iconSize: [45, 45]
                })
            });
            officeMarker.bindTooltip('Office de Tourisme', { 
                permanent: false, 
                direction: 'top',
                offset: [0, -20]
            });
            poiMarkers.push(officeMarker);
        }
        
        // Charger la route via OSRM
        async function loadRoute() {
            try {
                const coords = WAYPOINTS.map(([lng, lat]) => `${lng},${lat}`).join(';');
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.routes && data.routes[0]) {
                    const route = data.routes[0];
                    const coordinates = route.geometry.coordinates;
                    const latlngs = coordinates.map(([lng, lat]) => [lat, lng]);
                    
                    // Cr√©er la route compl√®te (invisible)
                    routeComplete = L.polyline(latlngs, {
                        color: '#D21F3C',
                        weight: 5,
                        opacity: 0
                    }).addTo(map);
                    
                    // Diviser en 4 segments
                    const totalPoints = latlngs.length;
                    const seg1End = Math.floor(totalPoints * 0.15);  // A√©roport ‚Üí Le Port
                    const seg2End = Math.floor(totalPoints * 0.35);  // Le Port ‚Üí Saint-Leu
                    const seg3End = Math.floor(totalPoints * 0.60);  // Saint-Leu ‚Üí Saint-Louis
                    
                    // Segment 1: A√©roport ‚Üí Le Port
                    segments[1] = L.polyline(latlngs.slice(0, seg1End), {
                        color: '#D21F3C',
                        weight: 5,
                        opacity: 0.3
                    }).addTo(map);
                    
                    // Segment 2: Le Port ‚Üí Saint-Leu
                    segments[2] = L.polyline(latlngs.slice(seg1End, seg2End), {
                        color: '#D21F3C',
                        weight: 5,
                        opacity: 0.3
                    }).addTo(map);
                    
                    // Segment 3: Saint-Leu ‚Üí Saint-Louis
                    segments[3] = L.polyline(latlngs.slice(seg2End, seg3End), {
                        color: '#D21F3C',
                        weight: 5,
                        opacity: 0.3
                    }).addTo(map);
                    
                    // Segment 4: Saint-Louis ‚Üí Cilaos
                    segments[4] = L.polyline(latlngs.slice(seg3End), {
                        color: '#D21F3C',
                        weight: 6,
                        opacity: 0.3,
                        dashArray: '10, 5'
                    }).addTo(map);
                    
                    console.log('‚úÖ Route OSRM charg√©e avec succ√®s');
                } else {
                    console.error('Pas de route trouv√©e');
                    // Fallback: ligne directe
                    createFallbackRoute();
                }
            } catch (error) {
                console.error('Erreur OSRM:', error);
                createFallbackRoute();
            }
        }
        
        // Route de secours si OSRM √©choue
        function createFallbackRoute() {
            const fallbackPoints = [
                [AIRPORT.lat, AIRPORT.lon],
                [PORT.lat, PORT.lon],
                [ST_LEU.lat, ST_LEU.lon],
                [ST_LOUIS.lat, ST_LOUIS.lon],
                [CILAOS.lat, CILAOS.lon]
            ];
            
            segments[1] = L.polyline(fallbackPoints.slice(0, 2), {
                color: '#D21F3C',
                weight: 5,
                opacity: 0.3,
                dashArray: '10, 10'
            }).addTo(map);
            
            segments[2] = L.polyline(fallbackPoints.slice(1, 3), {
                color: '#D21F3C',
                weight: 5,
                opacity: 0.3,
                dashArray: '10, 10'
            }).addTo(map);
            
            segments[3] = L.polyline(fallbackPoints.slice(2, 4), {
                color: '#D21F3C',
                weight: 5,
                opacity: 0.3,
                dashArray: '10, 10'
            }).addTo(map);
            
            segments[4] = L.polyline(fallbackPoints.slice(3, 5), {
                color: '#D21F3C',
                weight: 6,
                opacity: 0.3,
                dashArray: '5, 5'
            }).addTo(map);
        }
        
        // Fonction pour mettre en √©vidence un segment
        function highlightSegment(segmentNum) {
            // R√©initialiser tous les segments
            segments.forEach((seg, index) => {
                if (seg && index > 0) {
                    seg.setStyle({ 
                        opacity: 0.3,
                        weight: index === 4 ? 6 : 5
                    });
                }
            });
            
            // Mettre en √©vidence le segment actif
            if (segments[segmentNum]) {
                segments[segmentNum].setStyle({ 
                    opacity: 1,
                    weight: segmentNum === 4 ? 7 : 6
                });
            }
        }
        
        // Fonction pour afficher/masquer les POI
        function togglePOIs(show, isStLouis = false) {
            if (show && !poiVisible) {
                poiVisible = true;
                
                if (isStLouis) {
                    // Pour l'√©tape 3: afficher les POI comme num√©ros sur la vue Saint-Louis
                    document.getElementById('poiLegend').classList.add('visible');
                    poiMarkers.slice(0, 5).forEach((marker, index) => {
                        setTimeout(() => {
                            marker.addTo(map);
                        }, index * 100);
                    });
                } else {
                    // Pour l'√©tape 4: zoom sur Cilaos avec l'Office
                    map.removeLayer(cityMarkers.cilaos);
                    setTimeout(() => {
                        poiMarkers[5].addTo(map); // Office de tourisme uniquement
                    }, 500);
                }
            } else if (!show && poiVisible) {
                poiVisible = false;
                document.getElementById('poiLegend').classList.remove('visible');
                poiMarkers.forEach(marker => {
                    map.removeLayer(marker);
                });
                if (!cityMarkers.cilaos._map) {
                    cityMarkers.cilaos.addTo(map);
                }
            }
        }
        
        // Mettre √† jour l'info box
        function updateInfoBox(segment) {
            const infoTitle = document.getElementById('info-title');
            const infoText = document.getElementById('info-text');
            
            switch(segment) {
                case 1:
                    infoTitle.textContent = 'üåä √âtape 1: Le littoral nord';
                    infoText.textContent = 'De l\'a√©roport au Port, d√©couvrez la c√¥te sauvage avec ses falaises basaltiques et l\'oc√©an Indien. La route longe les champs de canne et les ravines spectaculaires.';
                    break;
                case 2:
                    infoTitle.textContent = 'üèñÔ∏è √âtape 2: La c√¥te ouest';
                    infoText.textContent = 'Du Port √† Saint-Leu, paradis du surf et du parapente. Le lagon prot√©g√© abrite tortues marines et poissons tropicaux. Les baleines s\'y donnent rendez-vous de juin √† octobre.';
                    break;
                case 3:
                    infoTitle.textContent = 'üåã √âtape 3: Vers les hauts';
                    infoText.textContent = 'De Saint-Leu √† Saint-Louis, la route s\'√©l√®ve progressivement. Au loin, les sommets de Cilaos se dessinent. Les points num√©rot√©s indiquent les merveilles qui vous attendent.';
                    break;
                case 4:
                    infoTitle.textContent = 'üèîÔ∏è √âtape 4: Les 400 virages';
                    infoText.textContent = 'La mythique RN5 et ses 421 virages ! Une route vertigineuse taill√©e dans la roche volcanique. L\'Office de Tourisme vous attend au c≈ìur du village.';
                    break;
            }
        }
        
        // √âcouter les messages du parent
        window.addEventListener('message', function(e) {
            if (!e.data || !e.data.action) return;
            
            if (e.data.action === 'updateView') {
                const data = e.data.data;
                currentSegment = parseInt(data.highlight.replace('segment', ''));
                
                // Mettre en √©vidence le segment
                highlightSegment(currentSegment);
                updateInfoBox(currentSegment);
                
                // Ajuster la vue selon l'√©tape
                switch(currentSegment) {
                    case 1:
                        // Vue g√©n√©rale avec focus sur A√©roport ‚Üí Le Port
                        togglePOIs(false);
                        map.flyTo([-20.95, 55.40], 11, { duration: 1.5 });
                        break;
                        
                    case 2:
                        // Vue g√©n√©rale avec focus sur Le Port ‚Üí Saint-Leu
                        togglePOIs(false);
                        map.flyTo([-21.05, 55.30], 11, { duration: 1.5 });
                        break;
                        
                    case 3:
                        // Zoom sur Saint-Louis avec POI de Cilaos en num√©ros
                        map.flyTo([-21.25, 55.42], 12, { duration: 1.5 });
                        setTimeout(() => {
                            togglePOIs(true, true);
                        }, 1200);
                        break;
                        
                    case 4:
                        // Zoom serr√© sur Cilaos avec Office de Tourisme
                        togglePOIs(false);
                        map.flyTo([-21.1364, 55.4719], 15, { duration: 2 });
                        setTimeout(() => {
                            togglePOIs(true, false);
                        }, 1800);
                        break;
                }
            }
        });
        
        // Initialisation
        createCityMarkers();
        createPOIMarkers();
        loadRoute();
        
        // Envoyer un message au parent
        if (window.parent !== window) {
            setTimeout(() => {
                window.parent.postMessage({ type: 'mapReady' }, '*');
            }, 1000);
        }
    </script>
</body>
</html>